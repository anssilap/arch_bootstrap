- hosts: localhost
  connection: local
  tasks:
  - name: Pacman update
    community.general.pacman:
      update_cache: yes
      upgrade: yes
    become: yes

  - name: Install yay
    # TODO Run this only if yay is not already installed
    block:
      - name: Register yay installed
        ansible.builtin.shell: yay --version | wc -l
        register: yay_installed
      - name: Get yay source code
        git:
          repo: https://aur.archlinux.org/yay-git.git
          dest: ~/yay-git
          when: yay_installed.stdout != "1"
      - name: Build and install yay
        command: chdir=~/yay-git makepkg -si --noconfirm
        when: yay_installed.stdout != "1"
      - name: Remove yay git directory
        command: rm -rf ~/yay-git
        when: yay_installed.stdout != "1"
    tags: yay
