- hosts: localhost
  connection: local
  tasks:
  - name: Register variables
    block:
      - name: Check if yay is installed
        ansible.builtin.shell: yay --version | wc -l
        register: yay_installed

  - name: Pacman update
    community.general.pacman:
      update_cache: yes
      upgrade: yes
    become: yes

  - name: Install Xorg
    community.general.pacman:
      name:
        - xorg
        - xorg-server
        - xorg-xinit
        - xorg-xrandr
      state: present
    become: yes
    tags:
      - xorg

  - name: Install and configure lightdm
    block:
      - name: Install lightdm
        community.general.pacman:
          name:
            - lightdm
          state: present
      - name: Enable lightdm
        command: systemctl enable lightdm
    become: yes
    tags:
      - lightdm

  - name: Install and enable lightdm pantheon greeter
    block:
      - name: Install lightdm pantheon greeter
        community.general.pacman:
          name:
            - lightdm-pantheon-greeter
          state: present
      - name: Enable pantheon-greeter for LightDM
        lineinfile:
          path: /etc/lightdm/lightdm.conf
          state: present
          regexp: 'greeter-session'
          line: greeter-session=io.elementary.greeter
    become: yes
    tags:
      - lightdm_pantheon_greeter

  - name: Install i3 and rofi
    community.general.pacman:
      name:
        - i3-gaps
        - rofi
      state: present
    become: yes
    tags:
      - i3
      - rofi

  - name: Install firefox
    community.general.pacman:
      name:
        - firefox
      state: present
    become: yes
    tags:
      - firefox

  - name: Install yay if not installed already
    block:
      - name: Get yay source code
        git:
          repo: https://aur.archlinux.org/yay-git.git
          dest: ~/yay-git
      - name: Build and install yay
        command: chdir=~/yay-git makepkg -si --noconfirm
      - name: Remove yay git directory
        command: rm -rf ~/yay-git
    when: yay_installed.stdout != "1"
    tags:
      - yay

  - name: Add hosts definitions for localhost
    block:
    - name: localhost IPv4
      lineinfile:
        path: /etc/hosts
        state: present
        regexp: '^127.0.0.1'
        line: 127.0.0.1     localhost
    - name: localhost IPv6
      lineinfile:
        path: /etc/hosts
        state: present
        regexp: '^::1'
        line: ::1           localhost
    become: yes
    tags:
      - hosts
